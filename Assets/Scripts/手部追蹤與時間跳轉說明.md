# æ‘ºç´™ç³»çµ±è£œå……èªªæ˜

## 1. ä¿®æ”¹å®Œæˆé …ç›®

### âœ… æ­¥é©Ÿç­‰å¾…æ™‚é–“
- **åŸæœ¬**ï¼šæ­¥é©Ÿå®Œæˆå¾Œç­‰å¾… 3 ç§’æ‰é¡¯ç¤ºä¸‹ä¸€æ­¥
- **ç¾åœ¨**ï¼šç­‰å¾… **0.5 ç§’**å°±é¡¯ç¤ºä¸‹ä¸€æ­¥
- **è¨­å®šä½ç½®**ï¼š`waitTimeAfterStep = 0.5f`ï¼ˆå¯åœ¨ Inspector èª¿æ•´ï¼‰

### âœ… æœ€å¾Œæ­¥é©Ÿå®Œæˆå¾Œé‡æ–°é–‹å§‹
- **è¡Œç‚º**ï¼šæœ€å¾Œä¸€å€‹æ­¥é©Ÿæ’­æ”¾å®Œç•¢å¾Œï¼ŒæŒ‰ `N` éµæœƒè‡ªå‹•é‡ç½®åˆ°ç¬¬ä¸€æ­¥é©Ÿ
- **å¯¦ç¾æ–¹å¼**ï¼š
  - æœ€å¾Œæ­¥é©Ÿå®Œæˆå¾Œ `currentStepIndex = -1` é€²å…¥ç­‰å¾…ç‹€æ…‹
  - æŒ‰ `N` è§¸ç™¼ `ResetToStart()` æ–¹æ³•
  - æ¸…é™¤æ‰€æœ‰è¦–è¦ºå…ƒç´ ï¼Œé‡ç½® Alembic å‹•ç•«åˆ° 0ï¼Œé‡æ–°å•Ÿå‹•æ­¥é©Ÿåºåˆ—

### âœ… çµæŸéŒ„å½±å¾Œä»å¯æŒ‰ N åˆ‡æ›
- **å•é¡Œ**ï¼šæ‰€æœ‰æ­¥é©Ÿå®Œæˆå¾Œç„¡æ³•æŒ‰ N
- **è§£æ±º**ï¼šç¾åœ¨æ‰€æœ‰æ­¥é©Ÿå®Œæˆå¾Œä»ä¿æŒ `isWaitingForTrigger = true`ï¼Œå¯æŒ‰ N é‡æ–°é–‹å§‹

## 2. Meta Avatar SDK æ‰‹éƒ¨è¿½è¹¤å•é¡Œ

### å•é¡Œåˆ†æ
ä½ çš„å ´æ™¯ä½¿ç”¨ **Meta Avatar SDK v40.0.1**ï¼Œæ‰‹éƒ¨è¿½è¹¤æ˜¯é€é Avatar SDK å…§éƒ¨è™•ç†ï¼Œ**ä¸æœƒ**åœ¨ Hierarchy ä¸­çœ‹åˆ°ç¨ç«‹çš„å·¦å³æ‰‹ GameObjectã€‚

### Avatar SDK æ‰‹éƒ¨è¿½è¹¤æ¶æ§‹

```
LocalAvatar (OvrAvatarEntity)
â”œâ”€â”€ OvrAvatarInputManager (ç¹¼æ‰¿è‡ª OvrAvatarInputManagerBehavior)
â”‚   â”œâ”€â”€ InputTrackingProvider (è¿½è¹¤é ­éƒ¨ã€æ§åˆ¶å™¨ä½ç½®)
â”‚   â”œâ”€â”€ HandTrackingProvider (è¿½è¹¤æ‰‹éƒ¨å§¿å‹¢) â† æ‰‹éƒ¨è¿½è¹¤åœ¨é€™è£¡
â”‚   â””â”€â”€ InputControlProvider (è¿½è¹¤è¼¸å…¥æŒ‰éˆ•)
â””â”€â”€ Avatar Mesh (ç”± SDK è‡ªå‹•ç”Ÿæˆ)
```

**é—œéµé»ï¼š**
- Avatar SDK ä½¿ç”¨ `OvrPluginHandTrackingProvider` è‡ªå‹•å¾ OVR Plugin ç²å–æ‰‹éƒ¨è¿½è¹¤æ•¸æ“š
- **ä¸éœ€è¦**ä¹Ÿ**çœ‹ä¸åˆ°**ç¨ç«‹çš„ OVRHand çµ„ä»¶
- æ‰‹éƒ¨è¿½è¹¤æ•¸æ“šç›´æ¥ç”¨æ–¼é©…å‹• Avatar çš„æ‰‹éƒ¨å‹•ç•«

### å¦‚ä½•ç²å–æ‰‹éƒ¨ä½ç½®å’Œ Pinch ç‹€æ…‹ï¼Ÿ

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ OVRPlugin ç›´æ¥è¨ªå•ï¼ˆæ¨è–¦ï¼‰

```csharp
using UnityEngine;

public class HandTrackingHelper : MonoBehaviour
{
    void Update()
    {
        // ç²å–å·¦æ‰‹æ•¸æ“š
        if (OVRPlugin.GetHandState(OVRPlugin.Step.Render, OVRPlugin.Hand.HandLeft, out var leftHandState))
        {
            // å·¦æ‰‹ä½ç½®
            Vector3 leftHandPos = leftHandState.PointerPose.Position.FromFlippedZVector3f();
            
            // é£ŸæŒ‡ Pinch å¼·åº¦
            float leftPinchStrength = leftHandState.PinchStrength[(int)OVRPlugin.HandFinger.Index];
            bool isLeftPinching = leftHandState.Pinches.HasFlag(OVRPlugin.HandFingerPinch.Index);
            
            Debug.Log($"Left Hand: Pos={leftHandPos}, Pinch={leftPinchStrength:F2}, IsPinching={isLeftPinching}");
        }
        
        // ç²å–å³æ‰‹æ•¸æ“š
        if (OVRPlugin.GetHandState(OVRPlugin.Step.Render, OVRPlugin.Hand.HandRight, out var rightHandState))
        {
            Vector3 rightHandPos = rightHandState.PointerPose.Position.FromFlippedZVector3f();
            float rightPinchStrength = rightHandState.PinchStrength[(int)OVRPlugin.HandFinger.Index];
            bool isRightPinching = rightHandState.Pinches.HasFlag(OVRPlugin.HandFingerPinch.Index);
            
            Debug.Log($"Right Hand: Pos={rightHandPos}, Pinch={rightPinchStrength:F2}, IsPinching={isRightPinching}");
        }
    }
}
```

#### æ–¹æ¡ˆ Bï¼šæ·»åŠ  OVRCameraRig + OVRHandï¼ˆéœ€è¦å ´æ™¯ä¿®æ”¹ï¼‰

å¦‚æœä½ æƒ³ä½¿ç”¨ `OVRHand` çµ„ä»¶ï¼Œéœ€è¦ï¼š

1. **æ·»åŠ  OVRCameraRig**
   ```
   Scene Hierarchy:
   â”œâ”€â”€ OVRCameraRig
   â”‚   â”œâ”€â”€ TrackingSpace
   â”‚   â”‚   â”œâ”€â”€ LeftHandAnchor
   â”‚   â”‚   â”‚   â””â”€â”€ LeftHand (OVRHand + OVRSkeleton)
   â”‚   â”‚   â”œâ”€â”€ RightHandAnchor
   â”‚   â”‚   â”‚   â””â”€â”€ RightHand (OVRHand + OVRSkeleton)
   â”‚   â”‚   â””â”€â”€ CenterEyeAnchor
   ```

2. **å¾ Project Settings å•Ÿç”¨ Hand Tracking**
   - `Edit > Project Settings > Meta XR`
   - `Hand Tracking Support` è¨­ç‚º `Controllers And Hands` æˆ– `Hands Only`

3. **ä¿®æ”¹ OrigamiStepGuideSimple.cs**
   ```csharp
   void FindHands()
   {
       // å¾ OVRCameraRig æ‰¾æ‰‹éƒ¨
       var leftAnchor = GameObject.Find("LeftHandAnchor");
       if (leftAnchor != null)
           leftHand = leftAnchor.GetComponentInChildren<OVRHand>();
       
       var rightAnchor = GameObject.Find("RightHandAnchor");
       if (rightAnchor != null)
           rightHand = rightAnchor.GetComponentInChildren<OVRHand>();
   }
   ```

### å»ºè­°ä¿®æ”¹ï¼šæ”¹ç”¨ OVRPlugin API

ä¿®æ”¹ `OrigamiStepGuideSimple.cs` çš„æ‰‹éƒ¨è¿½è¹¤éƒ¨åˆ†ï¼š

```csharp
void UpdateHandTracking()
{
    leftHandTracked = false;
    rightHandTracked = false;
    
    // ä½¿ç”¨ OVRPlugin ç›´æ¥ç²å–æ‰‹éƒ¨ç‹€æ…‹
    if (OVRPlugin.GetHandState(OVRPlugin.Step.Render, OVRPlugin.Hand.HandLeft, out var leftHandState))
    {
        leftHandIndexTip = leftHandState.PointerPose.Position.FromFlippedZVector3f();
        leftHandTracked = true;
        
        // æª¢æŸ¥ Pinch
        if (usePinchGesture)
        {
            float pinchStrength = leftHandState.PinchStrength[(int)OVRPlugin.HandFinger.Index];
            bool isPinching = leftHandState.Pinches.HasFlag(OVRPlugin.HandFingerPinch.Index);
            // ... è§¸ç™¼é‚è¼¯
        }
    }
    
    // åŒæ¨£è™•ç†å³æ‰‹
    if (OVRPlugin.GetHandState(OVRPlugin.Step.Render, OVRPlugin.Hand.HandRight, out var rightHandState))
    {
        rightHandIndexTip = rightHandState.PointerPose.Position.FromFlippedZVector3f();
        rightHandTracked = true;
    }
}
```

## 3. éŒ„è£½æª”æ¡ˆæ™‚é–“è·³è½‰æ”¯æ´

### âœ… æ”¯æ´è·³è½‰åˆ°æŒ‡å®šæ™‚é–“

ä½ çš„ `AvatarRecordingManager` **å®Œå…¨æ”¯æ´**è·³è½‰åˆ°ä»»æ„æ™‚é–“é»ï¼

#### éŒ„è£½æª”æ¡ˆçµæ§‹

```csharp
public class AvatarRecordingData
{
    public List<AvatarFrame> frames;        // Avatar å‹•ä½œå¹€ï¼ˆå«æ™‚é–“æˆ³ï¼‰
    public List<float> audioSamples;        // éŸ³é »æ¨£æœ¬ï¼ˆé€£çºŒï¼‰
    public List<OrigamiStepEvent> origamiStepEvents;  // æ‘ºç´™æ­¥é©Ÿäº‹ä»¶ï¼ˆå«æ™‚é–“æˆ³ï¼‰
    
    public int audioSampleRate;
    public int audioChannels;
}

public class AvatarFrame
{
    public float timestamp;     // å¹€çš„æ™‚é–“æˆ³ï¼ˆç§’ï¼‰
    public byte[] streamData;   // Avatar å‹•ä½œ+å˜´å‹æ•¸æ“š
}

public class OrigamiStepEvent
{
    public float timestamp;     // æ­¥é©Ÿåˆ‡æ›çš„æ™‚é–“æˆ³ï¼ˆç§’ï¼‰
    public int stepIndex;
    public string stepName;
}
```

#### å¦‚ä½•è·³è½‰åˆ° 3.4 ç§’

```csharp
// åœ¨ StudentPlaybackManager æˆ– AvatarRecordingManager ä¸­
public void JumpToTime(float targetTime)
{
    if (currentRecording == null) return;
    
    // 1. æ‰¾åˆ°å°æ‡‰çš„ Avatar å¹€
    int targetFrameIndex = -1;
    for (int i = 0; i < currentRecording.frames.Count; i++)
    {
        if (currentRecording.frames[i].timestamp >= targetTime)
        {
            targetFrameIndex = i;
            break;
        }
    }
    
    if (targetFrameIndex >= 0)
    {
        // 2. æ‡‰ç”¨è©²å¹€çš„ Avatar æ•¸æ“š
        remoteAvatar.ApplyStreamData(currentRecording.frames[targetFrameIndex].streamData);
        
        // 3. è·³è½‰éŸ³é »æ’­æ”¾ä½ç½®
        int audioSamplePosition = (int)(targetTime * currentRecording.audioSampleRate * currentRecording.audioChannels);
        playbackSource.timeSamples = audioSamplePosition;
        
        // 4. æ‰¾åˆ°å°æ‡‰çš„æ‘ºç´™æ­¥é©Ÿ
        int targetStep = GetCurrentOrigamiStep(targetTime);
        if (targetStep >= 0)
        {
            // é€šçŸ¥ OrigamiStepGuide è·³è½‰åˆ°è©²æ­¥é©Ÿ
            var stepGuide = FindObjectOfType<OrigamiStepGuideSimple>();
            if (stepGuide != null)
            {
                stepGuide.JumpToStep(targetStep);
            }
            
            // åŒæ™‚æ›´æ–° OrigamiSyncController çš„ Alembic å‹•ç•«
            var syncController = FindObjectOfType<OrigamiSyncController>();
            if (syncController != null && syncController.alembicPlayer != null)
            {
                // æ ¹æ“šæ­¥é©Ÿè¨ˆç®— Alembic æ™‚é–“
                float alembicTime = CalculateAlembicTimeForStep(targetStep, targetTime);
                syncController.alembicPlayer.CurrentTime = alembicTime;
            }
        }
        
        Debug.Log($"å·²è·³è½‰åˆ° {targetTime:F2} ç§’");
    }
}

// æ ¹æ“šæ­¥é©Ÿå’Œæ™‚é–“è¨ˆç®— Alembic å‹•ç•«æ™‚é–“
float CalculateAlembicTimeForStep(int stepIndex, float recordingTime)
{
    // ç²å–è©²æ­¥é©Ÿäº‹ä»¶çš„æ™‚é–“æˆ³
    var stepEvent = currentRecording.origamiStepEvents[stepIndex];
    float stepStartTime = stepEvent.timestamp;
    
    // è¨ˆç®—æ­¥é©Ÿå…§çš„ç›¸å°æ™‚é–“
    float elapsedInStep = recordingTime - stepStartTime;
    
    // æ˜ å°„åˆ° Alembic å‹•ç•«é€²åº¦
    var stepGuide = FindObjectOfType<OrigamiStepGuideSimple>();
    if (stepGuide != null && stepIndex < stepGuide.steps.Count)
    {
        var step = stepGuide.steps[stepIndex];
        float stepProgress = Mathf.Clamp01(elapsedInStep / step.duration);
        float targetProgress = Mathf.Lerp(step.progressStart, step.progressEnd, stepProgress);
        
        return targetProgress * alembicPlayer.Duration;
    }
    
    return 0f;
}
```

### å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

```csharp
// åœ¨æ’­æ”¾ä»‹é¢æ·»åŠ æ™‚é–“è»¸æ‹–æ›³åŠŸèƒ½
public class PlaybackController : MonoBehaviour
{
    public AvatarRecordingManager recordingManager;
    public Slider timelineSlider;
    
    void Start()
    {
        // è¨­å®šæ™‚é–“è»¸ç¯„åœ
        if (recordingManager.CurrentRecording != null)
        {
            timelineSlider.maxValue = recordingManager.CurrentRecording.totalDuration;
            timelineSlider.onValueChanged.AddListener(OnTimelineChanged);
        }
    }
    
    void OnTimelineChanged(float targetTime)
    {
        // è·³è½‰åˆ°ç”¨æˆ¶æ‹–æ›³çš„æ™‚é–“é»
        recordingManager.JumpToTime(targetTime);
    }
}
```

## 4. ç¸½çµ

### âœ… å·²å®Œæˆ
1. æ­¥é©Ÿç­‰å¾…æ™‚é–“æ”¹ç‚º 0.5 ç§’
2. æœ€å¾Œæ­¥é©Ÿå®Œæˆå¾ŒæŒ‰ N å¯é‡æ–°é–‹å§‹
3. æ‰€æœ‰æ­¥é©Ÿå®Œæˆå¾Œä»å¯æŒ‰ N åˆ‡æ›

### ğŸ“‹ éœ€è¦ä½ åŸ·è¡Œçš„æ“ä½œ

#### é—œæ–¼æ‰‹éƒ¨è¿½è¹¤ï¼š
**é¸é … Aï¼ˆæ¨è–¦ï¼‰ï¼š** ä¿®æ”¹ `OrigamiStepGuideSimple.cs` ä½¿ç”¨ `OVRPlugin.GetHandState()` API
- ä¸éœ€è¦ä¿®æ”¹å ´æ™¯
- ç›´æ¥å¾ Meta XR Plugin ç²å–æ‰‹éƒ¨æ•¸æ“š
- æ›´è¼•é‡ï¼Œæ€§èƒ½æ›´å¥½

**é¸é … Bï¼š** åœ¨å ´æ™¯ä¸­æ·»åŠ  `OVRCameraRig` å’Œ `OVRHand` çµ„ä»¶
- éœ€è¦é‡æ–°é…ç½®å ´æ™¯
- å¯ä»¥åœ¨ Scene View ä¸­çœ‹åˆ°æ‰‹éƒ¨ Gizmos
- æ›´ç›´è§€ï¼Œä½†éœ€è¦é¡å¤–çš„ GameObject

#### é—œæ–¼æ™‚é–“è·³è½‰ï¼š
ä½ çš„éŒ„è£½ç³»çµ±**å·²å®Œå…¨æ”¯æ´**æ™‚é–“è·³è½‰ï¼åªéœ€è¦å¯¦ä½œ `JumpToTime(float targetTime)` æ–¹æ³•å³å¯ã€‚

éœ€è¦æˆ‘å¹«ä½ ï¼š
1. å¯¦ä½œæ”¹ç”¨ OVRPlugin çš„æ‰‹éƒ¨è¿½è¹¤ç‰ˆæœ¬ï¼Ÿ
2. å¯¦ä½œ JumpToTime æ–¹æ³•ï¼Ÿ
3. å‰µå»ºæ’­æ”¾æ™‚é–“è»¸ UIï¼Ÿ

è«‹å‘Šè¨´æˆ‘ä½ æƒ³å…ˆè™•ç†å“ªå€‹éƒ¨åˆ†ï¼
